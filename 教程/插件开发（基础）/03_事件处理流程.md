# 事件处理流程

在上一章节中，我们已经定义了事件响应器，在这一章中，我们将会为事件响应器填充处理流程。

## 认识事件处理流程

在上一章（事件响应器）中，我们将事件响应器比作 “条件”，事件处理比作 “反射”。实际上的事件处理流程也正如反射一样，在事件响应器被触发之后会，事件被添加的处理依赖依次执行，直到所有处理依赖都执行完毕，或者遇到了某个处理依赖需要更多的事件来进行下一步的处理。在下一个事件到来并符合响应要求时，继续执行。

简单来说，事件处理流程并不是一个函数、一个对象或一个方法，而是一整套由开发者设计的流程。

在这个流程中，我们**目前**只需要了解两个概念——“处理依赖” 和 “事件响应器操作”。

### 处理依赖

在事件响应器中，事件处理流程由一个或多个处理依赖组成，每个处理依赖都是一个 `Dependent`，详情可以参考 ***进阶 - 依赖注入***。通常我们会采用事件响应器的依赖处理装饰器来添加依赖。

顾名思义，事件响应器的依赖处理装饰器是 [decorator](https://docs.python.org/zh-cn/3/glossary.html#term-decorator)，那么它的使用方法也同[函数定义](https://docs.python.org/zh-cn/3/reference/compound_stmts.html#function-definitions)中所展示的包装用法相同。例如：

```python title=foo.py {5,7}
from nonebot.plugin import on_command

matcher = on_command('ping')

@matcher.handle()
async def handle_func():
    pass # do something here
```

如上方示例所示，我们使用 `matcher` 响应器的 `handle` 装饰器装饰了一个函数 `handle_func` 。`handle_func` 函数会被自动转换为 `Dependent` 对象，并被添加到 `matcher` 的事件处理流程中。

>Tips
如果这个概念目前仍难以理解，你目前仅需要知道这种方法可以在事件响应器被调起之后自动调用 `handle_func` 来对事件进行处理即可。

目前 NoneBot2 共提供了 `handle`、`recive` 和 `got` 三种依赖处理装饰器，同时也可通过其他手段为事件响应器添加依赖处理，具体内容可参考 ***（进阶部分的对应内容）***。

### 事件响应器操作

在事件处理流程中，我们可以使用事件响应器操作来进行一些交互或改变事件处理流程，例如向用户发送消息或提前结束事件处理流程等。

事件响应器操作实际上同依赖处理装饰器一样，也是作为 `Matcher` 类的[类方法](https://docs.python.org/zh-cn/3/library/functions.html?highlight=classmethod#classmethod)存在，因此事件响应器操作的调用方法也是 `Matcher.func()` 的形式。不过不同的是，事件响应器操作并不是装饰器，因此并不需要@进行标注。

```python title=foo.py {7,8}
from nonebot.plugin import on_command

matcher = on_command('ping')

@matcher.handle()
async def handle_func():
    # await matcher.send('pong!')
    await matcher.finish('pong!')
```

如上方示例所示，我们使用 `matcher` 响应器的 `finish` 事件响应器操作方法向用户回复了 `pong!` 并结束了事件处理流程。效果如下图所示：

这里放个实例

>warning
值得注意的是，在使用了 `finish` 方法之后，NoneBot2 会在向用户回复其中的消息内容后抛出 `FinishedException` 来结束事件事件响应流程的后续操作。也就是说，如果在 `finish` 被执行后，后续的程序是不会被执行的（如果你需要回复用户消息但不想事件处理流程结束，可以使用被注释的部分中展示的 `send` 方法）。同时，如果你使用了 `try-except` 来捕获错误，那么 `finish` 抛出的 `FinishedException` 将不会被事件处理流程正确处理，导致无法正常结束此事件。例如：
>
>这里放个无法正常结束的实例

目前 NoneBot2 共提供了13种事件响应器操作，其中6种可用于和用户的交互，7种仅用于流程控制，具体内容可参考 ***（进阶部分的对应内容）***。
